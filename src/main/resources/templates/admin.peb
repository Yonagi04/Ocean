<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title data-i18n-key="title">Ocean 管理控制台</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
    header { background-color: #1f1f1f; text-align: center; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); position: relative; }
    header h1 { color: #00bcd4; margin: 0; font-size: 24px; }
    header p { color: #aaa; font-size: 14px; }
    .dashboard { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding: 20px; }
    .card { background-color: #1e1e1e; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.4); padding: 20px; width: 380px; transition: transform 0.2s ease; }
    .card:hover { transform: translateY(-5px); }
    .card h2 { color: #80deea; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px; }
    .metric { font-size: 16px; margin: 8px 0; }
    .metric strong { color: #00bcd4; font-weight: 600; }
    .chart-wrapper { height: 250px; width: 100%; position: relative; margin-top: 15px; }
    footer { text-align: center; color: #888; font-size: 13px; padding: 15px; border-top: 1px solid #333; }
    .refresh-hint { color: #999; font-size: 12px; margin-top: 8px; }

    /* 语言选择器优化 */
    .lang-selector-container {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
    }
    select.lang {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #333; 
      background-color: #2a2a2a; 
      color: #e0e0e0; 
      cursor: pointer;
      appearance: none; 
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 28px; 
    }
    select.lang:focus {
      outline: none;
      border-color: #00bcd4;
    }
  </style>
</head>
<body>
  <!-- 语言选择器放在一个容器中，便于定位 -->
  <div class="lang-selector-container">
    <select id="langSelect" class="lang">
      <option value="zh">简体中文</option>
      <option value="en">English</option>
      <option value="ja">日本語</option>
    </select>
  </div>
  
  <header>
    <h1 data-i18n-key="header_title">Ocean 管理控制台</h1>
    <p data-i18n-key="header_subtitle">服务器运行状态与实时指标，页面每 10 秒自动刷新</p>
  </header>

  <div class="dashboard">
    <!-- 线程池 -->
    <div class="card">
      <h2 data-i18n-key="threadpool_title">线程池状态</h2>
      <!-- 动态数据：使用 Span ID 标记，值包含在 Strong 标签内 -->
      <p class="metric" data-i18n-key="threadpool_active_threads">活跃线程数: <strong><span id="activeThreads">{{ activeThreads }}</span></strong></p>
      <p class="metric" data-i18n-key="threadpool_queue_size">队列等待数: <strong><span id="queueSize">{{ queueSize }}</span></strong></p>
      <div class="chart-wrapper">
        <canvas id="threadChart"></canvas>
      </div>
    </div>

    <!-- 请求延迟 -->
    <div class="card">
      <h2 data-i18n-key="request_latency_title">请求延迟 (所有请求)</h2>
      <p class="metric" data-i18n-key="request_total_count">请求总数: <strong><span id="reqTotal">{{ reqTotal }}</span></strong></p>
      <p class="metric" data-i18n-key="request_avg_latency">平均延迟: <strong><span id="avgLatency">{{ avgLatency }}</span> ms</strong></p>
      <p class="metric" data-i18n-key="request_max_latency">最大延迟: <strong><span id="maxLatency">{{ maxLatency }}</span> ms</strong></p>
      <div class="chart-wrapper">
        <canvas id="reqChart"></canvas>
      </div>
    </div>

    <!-- 缓存 -->
    <div class="card">
      <h2 data-i18n-key="cache_route_title">缓存与路由</h2>
      <p class="metric" data-i18n-key="cache_hit_client">端侧缓存命中总数: <strong><span id="cacheHit">{{ cacheHit }}</span></strong></p>
      <p class="metric" data-i18n-key="cache_hit_http">HTTP缓存命中总数: <strong><span id="httpCacheHit">{{ httpCacheHit }}</span></strong></p>
      <p class="metric" data-i18n-key="route_fallback_total">路由回退总数: <strong><span id="routeFallback">{{ routeFallback }}</span></strong></p>
      <div class="chart-wrapper">
        <canvas id="cacheChart"></canvas>
      </div>
    </div>

    <!-- 错误 -->
    <div class="card">
      <h2 data-i18n-key="error_ratelimit_title">错误与限流统计</h2>
      <p class="metric" data-i18n-key="error_404">404 Not Found: <strong><span id="notFound">{{ notFound }}</span></strong></p>
      <p class="metric" data-i18n-key="error_429">429 Rejected (限流): <strong><span id="ratelimit">{{ ratelimit }}</span></strong></p>
      <p class="metric" data-i18n-key="error_500">500 Internal Error: <strong><span id="internalError">{{ internalError }}</span></strong></p>
      <div class="chart-wrapper">
        <canvas id="errorChart"></canvas>
      </div>
    </div>
    
    <!-- 资源与环境 -->
    <div class="card" style="width: 800px;">
      <h2 data-i18n-key="env_info_title">资源与环境信息</h2>
      <div style="display: flex; justify-content: space-between;">
        <div style="flex: 1;">
          <!-- 静态数据：注意这里的值是直接由 Pebble 模板提供的，不是通过JS更新 -->
          <p class="metric" data-i18n-key="env_info_version">服务版本: <strong>{{ appVersion }}</strong></p>
          <p class="metric" data-i18n-key="env_info_java">Java 版本: <strong>{{ javaVersion }}</strong></p>
          <p class="metric" data-i18n-key="env_info_os">操作系统: <strong>{{ osName }}</strong></p>
        </div>
        <div style="flex: 1;">
          <p class="metric" data-i18n-key="env_info_uptime">已运行时间: <strong>{{ uptime }}</strong></p>
          <!-- 动态数据 (JVM/CPU)：现在确保它们的值也是在 <strong> 标签内 -->
          <p class="metric" data-i18n-key="env_info_memory">JVM 内存使用: <strong>{{ jvmMemoryUsed }} MB</strong></p>
          <p class="metric" data-i18n-key="env_info_cpu">进程 CPU 使用率: <strong>{{ processCpuUsage }} %</strong></p>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p class="refresh-hint" data-i18n-key="footer_refresh_hint">数据为当前时刻快照，自动刷新频率：10 秒。</p>
    Ocean © 2025
  </footer>

  <script>
    // --- I18N 翻译字典 (未修改) ---
    const translations = {
      'zh': {
        title: 'Ocean 管理控制台',
        header_title: 'Ocean 管理控制台',
        header_subtitle: '服务器运行状态与实时指标，页面每 10 秒自动刷新',
        
        threadpool_title: '线程池状态',
        threadpool_active_threads: '活跃线程数:',
        threadpool_queue_size: '队列等待数:',
        chart_label_active_threads: '活跃线程',
        chart_label_queue_size: '队列等待',
        chart_label_thread_unit: '线程数',

        request_latency_title: '请求延迟 (所有请求)',
        request_total_count: '请求总数:',
        request_avg_latency: '平均延迟:',
        request_max_latency: '最大延迟:',
        chart_label_avg_latency: '平均延迟(ms)',
        chart_label_max_latency: '最大延迟(ms)',
        chart_label_ms_unit: '毫秒 (ms)',

        cache_route_title: '缓存与路由',
        cache_hit_client: '端侧缓存命中总数:',
        cache_hit_http: 'HTTP缓存命中总数:',
        route_fallback_total: '路由回退总数:',
        chart_label_cache_client: '端侧缓存命中',
        chart_label_cache_http: 'HTTP缓存命中',

        error_ratelimit_title: '错误与限流统计',
        error_404: '404 Not Found:',
        error_429: '429 Rejected:',
        error_500: '500 Internal Error:',
        chart_label_error_unit: '次数',
        
        env_info_title: '资源与环境信息',
        env_info_version: '服务版本:',
        env_info_java: 'Java 版本:',
        env_info_os: '操作系统:',
        env_info_uptime: '已运行时间:',
        env_info_memory: 'JVM 内存使用:',
        env_info_cpu: '进程 CPU 使用率:',
        
        footer_refresh_hint: '数据为当前时刻快照，自动刷新频率：10 秒。',
      },
      'en': {
        title: 'Ocean Admin Console',
        header_title: 'Ocean Admin Console',
        header_subtitle: 'Server runtime status and real-time metrics, page auto-reloads every 10 seconds',

        threadpool_title: 'Thread Pool Status',
        threadpool_active_threads: 'Active Threads:',
        threadpool_queue_size: 'Queue Size:',
        chart_label_active_threads: 'Active Threads',
        chart_label_queue_size: 'Queue Wait',
        chart_label_thread_unit: 'Threads',

        request_latency_title: 'Request Latency (All Requests)',
        request_total_count: 'Total Requests:',
        request_avg_latency: 'Avg Latency:',
        request_max_latency: 'Max Latency:',
        chart_label_avg_latency: 'Avg Latency (ms)',
        chart_label_max_latency: 'Max Latency (ms)',
        chart_label_ms_unit: 'Milliseconds (ms)',
        
        cache_route_title: 'Cache & Routing',
        cache_hit_client: 'Client Cache Hits:',
        cache_hit_http: 'HTTP Cache Hits:',
        route_fallback_total: 'Route Fallbacks:',
        chart_label_cache_client: 'Client Cache Hits',
        chart_label_cache_http: 'HTTP Cache Hits',

        error_ratelimit_title: 'Errors & Rate Limiting',
        error_404: '404 Not Found:',
        error_429: '429 Rejected:',
        error_500: '500 Internal Error:',
        chart_label_error_unit: 'Count',

        env_info_title: 'Resources & Environment',
        env_info_version: 'Service Version:',
        env_info_java: 'Java Version:',
        env_info_os: 'Operating System:',
        env_info_uptime: 'Uptime:',
        env_info_memory: 'JVM Memory Used:',
        env_info_cpu: 'Process CPU Usage:',

        footer_refresh_hint: 'Data is a snapshot of the current time, auto-refresh frequency: 10 seconds.',
      },
      'ja': {
        title: 'Ocean 管理コンソール',
        header_title: 'Ocean 管理コンソール',
        header_subtitle: 'サーバーの実行状況とリアルタイムメトリクス。ページは10秒ごとに自動更新されます',

        threadpool_title: 'スレッドプール状態',
        threadpool_active_threads: 'アクティブスレッド数:',
        threadpool_queue_size: 'キューサイズ:',
        chart_label_active_threads: 'アクティブスレッド',
        chart_label_queue_size: 'キュー待機',
        chart_label_thread_unit: 'スレッド数',

        request_latency_title: 'リクエスト遅延 (全リクエスト)',
        request_total_count: 'リクエスト総数:',
        request_avg_latency: '平均遅延:',
        request_max_latency: '最大遅延:',
        chart_label_avg_latency: '平均遅延(ms)',
        chart_label_max_latency: '最大遅延(ms)',
        chart_label_ms_unit: 'ミリ秒 (ms)',

        cache_route_title: 'キャッシュとルーティング',
        cache_hit_client: 'クライアントキャッシュヒット総数:',
        cache_hit_http: 'HTTPキャッシュヒット総数:',
        route_fallback_total: 'ルーティングフォールバック総数:',
        chart_label_cache_client: 'クライアントキャッシュヒット',
        chart_label_cache_http: 'HTTPキャッシュヒット',

        error_ratelimit_title: 'エラーとレート制限',
        error_404: '404 Not Found:',
        error_429: '429 Rejected:',
        error_500: '500 Internal Error:',
        chart_label_error_unit: '回数',

        env_info_title: 'リソースと環境情報',
        env_info_version: 'サービスバージョン:',
        env_info_java: 'Java バージョン:',
        env_info_os: 'OS:',
        env_info_uptime: '稼働時間:',
        env_info_memory: 'JVMメモリ使用量:',
        env_info_cpu: 'プロセスCPU使用率:',
        
        footer_refresh_hint: 'データは現在のスナップショットです。自動更新頻度: 10秒。',
      }
    };

    let currentLang = 'zh';

    /**
     * 根据当前语言设置更新页面上所有带有 data-i18n-key 的文本
     * @param {string} lang - 目标语言代码 ('zh', 'en', 'ja')
     */
    function applyTranslations(lang) {
      const t = translations[lang] || translations['zh'];

      // 1. 翻译静态文本
      document.querySelectorAll('[data-i18n-key]').forEach(element => {
        const key = element.getAttribute('data-i18n-key');
        if (t[key]) {
          // 核心修正：查找并保存 strong 元素，因为它是所有 metric 值的容器
          const valueWrapper = element.querySelector('strong'); 

          // 1. 设置元素的文本内容 (这会清除所有子节点，包括 strong/span)
          element.textContent = t[key] + (valueWrapper ? ' ' : '');

          // 2. 如果找到了值容器，则重新将其添加到元素中
          if (valueWrapper) {
             element.appendChild(valueWrapper); 
          }
        }
      });
      
      initCharts(lang);
    }
    
    function initCharts(lang) {
        if (window.charts) {
            Object.values(window.charts).forEach(chart => chart.destroy());
        }
        window.charts = {};

        const t = translations[lang] || translations['zh'];
        const getMetricValue = (id) => {
            const el = document.getElementById(id);
            if (el) {
                return parseFloat(el.textContent.trim()) || 0;
            }
            return 0;
        };
        
        // 1. 线程池图表
        window.charts.threadChart = new Chart(document.getElementById('threadChart'), {
          type: 'bar',
          data: {
            labels: [t.chart_label_active_threads, t.chart_label_queue_size],
            datasets: [{
              label: t.threadpool_title,
              data: [getMetricValue('activeThreads'), getMetricValue('queueSize')],
              backgroundColor: ['#4dd0e1', '#ffc400']
            }]
          },
          options: {
            scales: { y: { beginAtZero: true, title: { display: true, text: t.chart_label_thread_unit } } },
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });

        // 2. 请求延迟图表
        window.charts.reqChart = new Chart(document.getElementById('reqChart'), {
          type: 'bar',
          data: {
            labels: [t.chart_label_avg_latency, t.chart_label_max_latency],
            datasets: [{
              label: t.request_latency_title,
              data: [getMetricValue('avgLatency'), getMetricValue('maxLatency')],
              backgroundColor: ['#64b5f6', '#d32f2f']
            }]
          },
          options: {
            scales: { y: { beginAtZero: true, title: { display: true, text: t.chart_label_ms_unit } } },
            plugins: { legend: { display: false } },
            responsive: true,
            maintainAspectRatio: false
          }
        });

        // 3. 缓存命中图表
        window.charts.cacheChart = new Chart(document.getElementById('cacheChart'), {
          type: 'doughnut',
          data: {
            labels: [t.chart_label_cache_client, t.chart_label_cache_http],
            datasets: [{
              label: t.cache_route_title,
              data: [getMetricValue('cacheHit'), getMetricValue('httpCacheHit')],
              backgroundColor: ['#81c784', '#ff8a65']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });

        // 4. 错误与限流图表
        window.charts.errorChart = new Chart(document.getElementById('errorChart'), {
          type: 'bar',
          data: {
            labels: ['404', '429', '500'],
            datasets: [{
              label: t.error_ratelimit_title,
              data: [getMetricValue('notFound'), getMetricValue('ratelimit'), getMetricValue('internalError')],
              backgroundColor: ['#ffcdd2', '#ffeb3b', '#ef5350']
            }]
          },
          options: {
            scales: { y: { beginAtZero: true, title: { display: true, text: t.chart_label_error_unit } } },
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
    }

    // --- 初始化逻辑 ---
    window.onload = function() {
        const langSelect = document.getElementById('langSelect');
        const urlParams = new URLSearchParams(window.location.search);
        
        // 1. 获取语言偏好：优先URL参数，其次 localStorage，最后默认中文
        let savedLang = urlParams.get('lang') || localStorage.getItem('adminLang') || 'zh';

        // 2. 确保选择器和当前语言状态一致
        if (langSelect.querySelector(`option[value="${savedLang}"]`)) {
            langSelect.value = savedLang;
            currentLang = savedLang;
        }

        // 3. 应用翻译 (修复后的函数)
        applyTranslations(currentLang);
        
        // 4. 监听切换事件
        langSelect.addEventListener('change', function() {
            const newLang = this.value;
            localStorage.setItem('adminLang', newLang);
            // 重新加载页面，带上语言参数
            window.location.search = `?lang=${newLang}`;
        });
        
        // 5. 设置自动刷新（10秒）
        setTimeout(() => location.reload(), 10000);
    };
  </script>
</body>
</html>
